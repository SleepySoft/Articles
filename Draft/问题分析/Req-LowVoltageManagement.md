## 起因

今天遇到一个有意思的需求问题。

我们的BMS（锂电池管理系统，每个锂电池柜都有一个BMS对其进行管理）项目需要实现一个“低压管理”的功能。前期做了好几次设计，流程图和设计文档做得非常复杂，但对于这个功能SA（System Architect）一直不满意。

我的建议是SA应该先将这个问题以WAHT的形式提出来，然后我们一起分析HOW。然后他提出的WHAT如下：

+ 当电池亏电的情况下BMS开机，UPS可对电池充电

+ BMS开机后30天内，不需要人为干预，UPS可对电池充电 

+ BMS深度放电后30天内，不需要人为干预，UPS可对电池充电 

我来解释一下：

公司的主要产品是UPS（不间断电源）。锂电池柜连接到UPS，在市电断开时给UPS供电；而在市电恢复的时候，UPS会给锂电池充电。从而实现一个“不间断”的电源。

当电池放电时电压达到B时，BMS为了保护电池，会断开Relay，这个电压也是上面“亏电”和“深度放电后”的量化定义；而当电压降到A(A<B)时，则BMS会断开MCCB。

Relay和MCCB都是开关，它们的区别在于：Relay可以受程序控制断开和闭合，而MCCB断开后只能通过手动闭合，程序无法干预。

Relay和MCCB是串联的，只要其中一个断开，功率回路就会被切断；只有两个都处于闭合状态，功率回路才能接通。

另外，只有当功率回路接通时，BMS才能知道当前是在充电还是在放电，这点很重要。
UPS进入充电状态可能需要一小段时间，所以即使没检测到充电，功率回路也需要保持一段时间。

这么一来这个需求可以这么理解：

> 当电池达到电压达到B后，Relay断开，但之后BMS会定期闭合Relay尝试充电。
> 
> 如果Relay闭合后没有检测到充电，则需要及时断开Relay以避免进一步耗电，尽量不要让电压降到A（从而只能靠人介入）。
> 
> 希望这种状态至少能持续30天。

那为什么这个功能会这么纠结呢？因为这里面有各种干扰因素：

+ 电池在BMS彻底关机“休息”后，电压是会上升的，这样一来开机后的电压会高于关机时的电压B

+ 考虑到上面这点，在设计时引入了SoC（可以理解为百分比电量）来判定电池状态

+ 如果BMS有额外供电（仅给电路供电，不能给电池充电），不需要从自己的电池取电，那么电池明显能坚持的时间更长

+ 除了BMS会控制Relay闭合尝试充电，用户也有可能发送指令要求BMS闭合Relay

结果在各种各种可能性组合下，为了追求最长的待机时间，导致分支爆炸


## 分析

那么这个问题的本质是什么呢？我给出的答案是：

**重试充电的频率和重试充电的超时**

没错，这个需求的核心就是BMS需要在功率回路切断的情况下定期尝试接通功率回路充电，同时避免因为功率回路接通却得不到充电导致的持续耗电问题。

而其干扰项是不影响的：

+ 电压上升后本来就能接通功率回路，直到下降到电压等级B时才进入这个功能的流程

+ SoC这种二手数据是不必要的，这些判定只跟电压有关

+ BMS有额外供电能延长这个功能坚持的时间，但不影响这个功能的核心逻辑

+ 用户控制Relay闭合后我们可以重置BMS下次重试的计时，超时逻辑是相同的

但另一个30天的需求，又怎样能满足呢？


## 解决

为了验证这个需求的可行性，我们需要按下表做一系列实验：

| 放电电流 | 持续时间 |
| --- | --- |
| 0.5A | ？s |
| 1.5A | ？s |
| 2.5A | ？s |
| 3.5A | ？s |

即当电池达到**电压B**时，采用不同的电流进行放电直到**电压A**，能持续多久。

当然，最好可以尝试不同工况。比如基于放电截止/开机，BMS板子有/无独立供电。实际上，BMS板子的耗电量非常低，完全可以只考虑最差情况从而减少工况。

这样一来，我们就能用数据评估尝试充电的超时时间，以及重试的频率，并且可以回答30天的需求是否合理。
