## 起因

今天遇到一个有意思的需求问题。

我们BMS项目需要实现一个“低压管理”的功能，前期做了好几次设计，流程图和设计文档做得非常复杂，但对于这个功能SA（System Architect）一直不满意。

我的建议是SA应该先将这个问题以WAHT的形式提出来，然后我们一起分析HOW。然后他提出的WHAT如下：

+ 当电池亏电的情况下BMS开机，UPS可对电池充电

+ BMS开机后30天内，不需要人为干预，UPS可对电池充电 

+ BMS深度放电后30天内，不需要人为干预，UPS可对电池充电 

我来解释一下：

公司的主要产品是UPS（不间断电源），而BMS是锂电池管理系统，每个锂电池柜都有一个BMS对其进行管理。
锂电池柜连接到UPS，在市电断开时给UPS供电；而在市电恢复的时候，UPS会给锂电池充电。从而实现一个“不间断”的电源。

当电池放电时电压达到等级B时，BMS为了保护电池，会断开Relay；而当电压降到等级A时，则BMS会断开MCCB。它们是两个串联的开关，只要其中一个断开，功率回路就会被切断。

这两个开关的区别在于：Relay可以受程序控制断开和闭合，而MCCB断开后只能通过手动闭合，程序无法干预。

另外，只有当功率回路闭合时，BMS才能知道当前是在充电还是在放电，这点很重要。

这么一来这个需求可以这么理解：

> 当电池达到电压达到等级B后，Relay断开，之后会尝试闭合Relay检测充电状态。
> 
> 如果没有在充电，则需要及时断开Relay以避免进一步耗电，尽量不要让电压降到等级A（从而只能靠人介入）。
> 
> 希望这种状态至少能持续30天。

那为什么这个功能会这么纠结呢？因为这里面有干扰因素：

+ 电池在BMS彻底关机“休息”后，电压是会上升的，这样一来开机后电压会高于关机时的电压等级B

+ 考虑到上面这点，在设计时引入了SoC（可以理解为百分比电量）来判定电池状态

+ 如果BMS有额外供电（不需要从自己的电池取电），那么明显能坚持的时间更长

+ 除了BMS控制闭合Relay尝试充电，用户也有可能发送指令要求BMS闭合Relay

如此一来各科可能性组合，导致分支爆炸。


## 分析

那么这个问题的本质是什么呢？

> 





